name: Seguridad de Imagen Docker (Scout Local)

# Este flujo de trabajo se ejecuta manualmente (workflow_dispatch)
# o después del CI principal.
on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Tag de la imagen a escanear (e.g., latest o un SHA)'
        required: true
        default: 'latest'

permissions:
  contents: read
  security-events: write

jobs:
  docker_security_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        # Necesario para que la acción de Scout pueda crear el comentario de PR
        # SHA: 34e114876b0b11c390a56381ad16ebd13914f8d5 (v4)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      # -----------------------------------
      # DOCKER CONFIGURATION (Pinning SHA)
      # -----------------------------------
      - name: Set up Docker Buildx
        # SHA: d70bba73f7c00e4e95147be8859e205566089851 (v2)
        uses: docker/setup-buildx-action@d70bba73f7c00e4e95147be8859e205566089851

      - name: Log in to Docker Hub
        # SHA: 8251e626e274ccaa29c3d4a6755106a4b138e6e9 (v2)
        uses: docker/login-action@8251e626e274ccaa29c3d4a6755106a4b138e6e9
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull Docker image (Para escaneo local)
        # Descarga la imagen que ya fue publicada por el CI principal
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/autoparts:${{ github.event.inputs.image_tag }}

      # -----------------------------------
      # DOCKER SCOUT (Escaneo Local y Gratuito)
      # -----------------------------------
      - name: Docker Scout – Scan image for CVEs (Local)
        # SHA: 890885e3477144e510803af9f64a18012423855a (v1)
        # Esto usará el escaneo local ilimitado, evitando el error de licencia.
        uses: docker/scout-action@890885e3477144e510803af9f64a18012423855a
        with:
          command: cves
          # Escanea la imagen descargada localmente.
          image: ${{ secrets.DOCKERHUB_USERNAME }}/autoparts:${{ github.event.inputs.image_tag }}
          summary: true
          only-fixed: true
          format: table
          write-comment: true
          github-token: ${{ secrets.GITHUB_TOKEN }}